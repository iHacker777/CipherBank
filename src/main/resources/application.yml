spring:
  application:
    name: cipherbank

  # ============================================================================
  # DUAL DATABASE CONFIGURATION
  # ============================================================================

  # Security Database Configuration
  # Database: cipherbank_security
  # Tables: users, roles, user_roles, ip_whitelist
  # Purpose: Authentication, authorization, IP whitelisting
  datasource:
    security:
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbc-url: jdbc:mysql://34.180.14.173:3306/paytrix_db?serverTimezone=UTC&allowPublicKeyRetrieval=true
      username: root
      password: password
      hikari:
        connection-timeout: 30000
        maximum-pool-size: 10
        minimum-idle: 5
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: SecurityHikariPool

    # Business Database Configuration (PRIMARY)
    # Database: cipherbank
    # Tables: bank_statements, bank_profiles, bank_statement_uploads
    # Purpose: Business logic, payment processing
    business:
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbc-url: jdbc:mysql://34.180.14.173:3306/cipherbank?serverTimezone=UTC&allowPublicKeyRetrieval=true
      username: root
      password: password
      hikari:
        connection-timeout: 30000
        maximum-pool-size: 20
        minimum-idle: 10
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: BusinessHikariPool

  # ============================================================================
  # JPA CONFIGURATION
  # ============================================================================
  jpa:
    security:
      show-sql: true
      format-sql: true
      hibernate:
        ddl-auto: update
        dialect: org.hibernate.dialect.MySQLDialect
        naming:
          physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
          implicit-strategy: org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
      properties:
        hibernate:
          dialect: org.hibernate.dialect.MySQLDialect
          format_sql: true
          use_sql_comments: true
          jdbc:
            batch_size: 20
            fetch_size: 50
          order_inserts: true
          order_updates: true

    business:
      show-sql: true
      format-sql: true
      hibernate:
        ddl-auto: update
        dialect: org.hibernate.dialect.MySQLDialect
        naming:
          physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
          implicit-strategy: org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
      properties:
        hibernate:
          dialect: org.hibernate.dialect.MySQLDialect
          format_sql: true
          use_sql_comments: true
          jdbc:
            batch_size: 20
            fetch_size: 50
          order_inserts: true
          order_updates: true

  # ============================================================================
  # FILE UPLOAD CONFIGURATION
  # ============================================================================
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB
      file-size-threshold: 0
      location: /tmp

  # ============================================================================
  # KAFKA CONFIGURATION
  # ============================================================================
  kafka:
    bootstrap-servers: localhost:9092  # Change for production

    # Producer Configuration (CipherBank publishes statements)
    producer:
      key-serializer: org.apache.kafka.common.serialization.LongSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all  # Wait for all replicas to acknowledge
      retries: 3  # Retry on transient failures
      properties:
        enable.idempotence: true  # Exactly-once semantics
        max.in.flight.requests.per.connection: 5
        compression.type: snappy  # Compress messages
        linger.ms: 10  # Batch messages for 10ms
        batch.size: 16384  # 16KB batch size

    # Consumer Configuration (CipherBank consumes responses)
    consumer:
      group-id: cipherbank-statement-response-consumer
      key-deserializer: org.apache.kafka.common.serialization.LongDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      enable-auto-commit: false  # Manual commit for reliability
      auto-offset-reset: earliest  # Start from beginning on first run
      max-poll-records: 100  # Process 100 messages per poll
      properties:
        spring.json.trusted.packages: com.paytrix.cipherbank.*
        isolation.level: read_committed  # Only read committed messages
        session.timeout.ms: 30000  # 30 second session timeout
        heartbeat.interval.ms: 10000  # 10 second heartbeat

    # Listener Configuration
    listener:
      ack-mode: manual  # Manual acknowledgment
      concurrency: 3  # 3 consumer threads (half of partitions)
      type: batch  # Can be 'single' or 'batch'

# ============================================================================
# KAFKA TOPICS CONFIGURATION
# ============================================================================
kafka:
  topics:
    # Topic: CipherBank → Gateway
    statements-uploaded:
      name: bank.statements.uploaded
      partitions: 6
      replication-factor: 1  # Use 3 in production

    # Topic: Gateway → CipherBank
    statements-processed:
      name: payment.statements.processed
      partitions: 6
      replication-factor: 1  # Use 3 in production

    # Dead Letter Queue
    statements-dlq:
      name: bank.statements.uploaded.dlq
      partitions: 3
      replication-factor: 1  # Use 3 in production

  # Consumer configuration
  consumer:
    group-id: cipherbank-statement-response-consumer
    concurrency: 3  # Number of consumer threads

  # Producer configuration
  producer:
    retry-attempts: 3
    retry-backoff-ms: 1000

# ============================================================================
# MONITORING & METRICS
# ============================================================================
management:
  metrics:
    tags:
      application: ${spring.application.name}
    export:
      prometheus:
        enabled: true
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus

# ============================================================================
# SWAGGER/OPENAPI CONFIGURATION
# ============================================================================
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html

# ============================================================================
# JWT CONFIGURATION
# ============================================================================
jwt:
  secret: secret-key1234-secret-key1234-admin   # 32+ chars for HS256
  encryption-secret: 3f7a9c1d2b4e5f8091a2b3c4d5e6f701   # 128 bits encryption key
  expiration: 900000  # 15 minutes in milliseconds

# ============================================================================
# IP WHITELIST SECURITY CONFIGURATION
# ============================================================================
security:
  ip-whitelist:
    enabled: true      # Set to false to disable IP whitelist filtering
    debug: false       # Set to true to see detailed IP extraction logs (useful for debugging proxy issues)

# ============================================================================
# STATEMENT QUERY CONFIGURATION
# ============================================================================
statement:
  # Query pagination and sorting configuration
  query:
    max-page-size: 100          # Maximum records per page (range: 1-1000)
    default-page-size: 20       # Default when not specified (range: 1-100)
    default-sort-column: transactionDateTime    # Default sort column
    default-sort-direction: desc                # Default sort direction (asc/desc)

  # Role-based column visibility configuration
  # Controls which columns are visible to different user roles
  # Column names must match BankStatementResponse field names exactly
  columns:
    visibility:
      # ROLE_ADMIN: Full access to all columns
      admin:
        - id                        # Statement ID
        - transactionDateTime       # Transaction date/time
        - amount                    # Transaction amount
        - balance                   # Account balance after transaction
        - orderId                   # Order/Transaction ID
        - reference                 # Payment reference/description
        - payIn                     # Credit/Debit flag
        - accountNo                 # Bank account number
        - utr                       # Unique Transaction Reference
        - gatewayTransactionId      # Gateway transaction ID
        - uploadTimestamp           # Upload timestamp
        - approvalStatus            # Approval status (PENDING/APPROVED/REJECTED)
        - processed                 # Processing status (true/false)
        - type                      # Transaction type
        - uploadId                  # Upload ID
        - uploadUsername            # Username who uploaded
        - bankName                  # Bank name
        - bankParserKey             # Bank parser key (iob/kgb/indianbank)

      # ROLE_USER: Limited access to non-sensitive columns
      user:
        - transactionDateTime       # Transaction date/time
        - amount                    # Transaction amount
        - orderId                   # Order/Transaction ID
        - reference                 # Payment reference/description
        - payIn                     # Credit/Debit flag
        - utr                       # Unique Transaction Reference
        - uploadTimestamp           # Upload timestamp
        - bankName                  # Bank name

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
logging:
  level:
    root: INFO
    # Security Database Logs
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.repository.security: DEBUG
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.adapter.security: DEBUG
    # Business Database Logs
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.repository.business: DEBUG
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.adapter.business: DEBUG
    # Hibernate SQL (shows queries from both databases)
    org.hibernate.SQL: DEBUG
    # org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    # Application logs
    com.paytrix.cipherbank: INFO
    # DataSource logs (to see which database is being used)
    com.zaxxer.hikari.HikariConfig: DEBUG
    com.zaxxer.hikari.HikariDataSource: INFO
    org.apache.kafka: INFO
    org.springframework.kafka: INFO
    com.paytrix.cipherbank.infrastructure.adapter.out.kafka: DEBUG
    com.paytrix.cipherbank.infrastructure.adapter.in.kafka: DEBUG