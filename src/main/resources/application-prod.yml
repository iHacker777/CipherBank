spring:
  application:
    name: cipherbank

  # ============================================================================
  # DUAL DATABASE CONFIGURATION (PRODUCTION)
  # ============================================================================

  # Security Database Configuration
  # Database: paytrix_db (contains security tables)
  # Tables: users, roles, user_roles, ip_whitelist
  # Purpose: Authentication, authorization, IP whitelisting
  datasource:
    security:
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbc-url: jdbc:mysql://private-db-mysql-blr1-87014-do-user-31560217-0.l.db.ondigitalocean.com:25060/paytrix_db?serverTimezone=UTC&allowPublicKeyRetrieval=true
      username: doadmin
      password: AVNS_XwRLneBUvulqG_Szb6K
      hikari:
        connection-timeout: 30000
        maximum-pool-size: 10
        minimum-idle: 5
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: SecurityHikariPool

    # Business Database Configuration (PRIMARY)
    # Database: cipherbank
    # Tables: bank_statements, bank_profiles, bank_statement_uploads
    # Purpose: Business logic, payment processing
    business:
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbc-url: jdbc:mysql://private-db-mysql-blr1-87014-do-user-31560217-0.l.db.ondigitalocean.com:25060/cipherbank?serverTimezone=UTC&allowPublicKeyRetrieval=true
      username: doadmin
      password: AVNS_XwRLneBUvulqG_Szb6K
      hikari:
        connection-timeout: 30000
        maximum-pool-size: 20
        minimum-idle: 10
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: BusinessHikariPool

  # ============================================================================
  # JPA CONFIGURATION - SECURITY DATABASE (PRODUCTION)
  # ============================================================================
  jpa:
    security:
      show-sql: true
      format-sql: true
      hibernate:
        ddl-auto: update
        dialect: org.hibernate.dialect.MySQLDialect
        naming:
          physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
          implicit-strategy: org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
      properties:
        hibernate:
          dialect: org.hibernate.dialect.MySQLDialect
          format_sql: true
          use_sql_comments: true
          jdbc:
            batch_size: 20
            fetch_size: 50
          order_inserts: true
          order_updates: true

    # ============================================================================
    # JPA CONFIGURATION - BUSINESS DATABASE (PRIMARY - PRODUCTION)
    # ============================================================================
    business:
      show-sql: true
      format-sql: true
      hibernate:
        ddl-auto: update
        dialect: org.hibernate.dialect.MySQLDialect
        naming:
          physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
          implicit-strategy: org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
      properties:
        hibernate:
          dialect: org.hibernate.dialect.MySQLDialect
          format_sql: true
          use_sql_comments: true
          jdbc:
            batch_size: 20
            fetch_size: 50
          order_inserts: true
          order_updates: true

  # ============================================================================
  # FILE UPLOAD CONFIGURATION (PRODUCTION)
  # ============================================================================
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB      # Spring's max file size (must match our config)
      max-request-size: 10MB   # Spring's max request size
      file-size-threshold: 0
      location: /tmp

  # ============================================================================
  # CUSTOM FILE UPLOAD CONFIGURATION (PRODUCTION)
  # ============================================================================
  file:
    upload:
      max-file-size-mb: 10       # Our application-level max file size in MB
      allowed-extensions: # Allowed file extensions (with dot)
        - .csv
        - .xls
        - .xlsx
        - .pdf

  # ============================================================================
  # KAFKA CONFIGURATION (PRODUCTION)
  # ============================================================================
  kafka:
    # Kafka Bootstrap Servers (PRODUCTION CLUSTER)
    bootstrap-servers: localhost:9092
    # Example production: kafka-prod-1.example.com:9092,kafka-prod-2.example.com:9092,kafka-prod-3.example.com:9092

    # Producer Configuration
    producer:
      # Serializers (SAME as dev)
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

      # Reliability settings (SAME as dev)
      acks: all  # Wait for all replicas to acknowledge
      retries: 3

      # Idempotence (exactly-once semantics)
      properties:
        enable.idempotence: true
        max.in.flight.requests.per.connection: 5

        # Compression (SAME as dev)
        compression.type: snappy

        # Batch settings for throughput (SAME as dev)
        batch.size: 16384
        linger.ms: 10
        buffer.memory: 33554432

    # Consumer Configuration
    consumer:
      # Serializers with error handling (SAME as dev)
      key-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer

      # Consumer group (SAME as dev)
      group-id: cipherbank-statement-response-consumer

      # Consumer behavior (SAME as dev)
      auto-offset-reset: earliest  # Start from beginning if no offset
      enable-auto-commit: false  # Manual commit for reliability

      # Delegate deserializers and JSON settings (SAME as dev)
      properties:
        spring.deserializer.key.delegate.class: org.apache.kafka.common.serialization.LongDeserializer
        spring.deserializer.value.delegate.class: org.springframework.kafka.support.serializer.JsonDeserializer
        spring.json.trusted.packages: com.paytrix.cipherbank.*
        spring.json.value.default.type: com.paytrix.cipherbank.infrastructure.adapter.in.kafka.event.StatementProcessedEvent

        # Session and polling (SAME as dev)
        session.timeout.ms: 30000  # 30 seconds
        heartbeat.interval.ms: 10000  # 10 seconds
        max.poll.interval.ms: 300000  # 5 minutes
        max.poll.records: 100

        # Isolation level (only read committed messages)
        isolation.level: read_committed

    # Listener Configuration
    listener:
      # Acknowledgment mode (SAME as dev)
      ack-mode: manual  # Manual acknowledgment for control

      # Concurrency (number of consumer threads)
      # PROD: 6 threads (higher load, more throughput)
      concurrency: 6

      # Error handling (SAME as dev)
      type: batch  # Process records in batches

# ============================================================================
# SWAGGER/OPENAPI CONFIGURATION (PRODUCTION)
# ============================================================================
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html

# ============================================================================
# JWT CONFIGURATION (PRODUCTION)
# ============================================================================
jwt:
  secret: secret-key1234-secret-key1234-admin   # 32+ chars for HS256
  encryption-secret: 3f7a9c1d2b4e5f8091a2b3c4d5e6f701   # 128 bits encryption key
  expiration: 900000  # 15 minutes in milliseconds

# ============================================================================
# IP WHITELIST SECURITY CONFIGURATION (PRODUCTION)
# ============================================================================
security:
  ip-whitelist:
    enabled: false      # Set to false to disable IP whitelist filtering
    debug: true        # Set to true to see detailed IP extraction logs (useful for debugging proxy issues)

# ============================================================================
# KAFKA TOPIC CONFIGURATION (PRODUCTION)
# ============================================================================
kafka:
  # Topic: bank.statements.uploaded (CipherBank -> Gateway)
  topic:
    bank-statements-uploaded:
      name: bank.statements.uploaded
      partitions: 6  # SAME as dev
      replication-factor: 3  # PROD: 3 replicas (high availability)
      retention-ms: 604800000  # 7 days (SAME as dev)
      compression-type: snappy  # SAME as dev

    # Topic: payment.statements.processed (Gateway -> CipherBank)
    payment-statements-processed:
      name: payment.statements.processed
      partitions: 6  # SAME as dev
      replication-factor: 3  # PROD: 3 replicas (high availability)
      retention-ms: 259200000  # 3 days (SAME as dev)
      compression-type: snappy  # SAME as dev

    bank-statements-dlq:
      name: bank.statements.dlq
      partitions: 3
      replication-factor: 1  # DEV: 1 (single broker)
      retention-ms: 259200000  # 7 days
      compression-type: snappy

  # Consumer Configuration
  consumer:
    # Consumer group ID (SAME as dev)
    group-id: cipherbank-statement-response-consumer

    # Concurrency (consumer threads)
    # PROD: 6 threads per topic (higher throughput)
    concurrency: 6

    # Polling configuration (SAME as dev)
    max-poll-records: 100
    max-poll-interval-ms: 300000  # 5 minutes
    session-timeout-ms: 30000  # 30 seconds
    heartbeat-interval-ms: 10000  # 10 seconds

  # Producer Configuration
  producer:
    # Retry configuration (SAME as dev)
    retries: 3
    retry-backoff-ms: 100

    # Batch configuration (SAME as dev)
    batch-size: 16384
    linger-ms: 10

    # Compression (SAME as dev)
    compression-type: snappy

    # Idempotence (SAME as dev)
    enable-idempotence: true

  # Admin Configuration (for topic creation)
  admin:
    auto-create: true  # PROD: false (manual topic creation for control)
    operation-timeout: 30000  # SAME as dev

# ============================================================================
# STATEMENT UPLOAD PERFORMANCE AND QUERY SERVICE CONFIGURATION (PRODUCTION)
# ============================================================================
statement:
  upload:
    # PRODUCTION: Higher batch size for better throughput
    batch-size: 200

    # PRODUCTION: Enable parallel processing for large files
    # Make sure database connection pool can handle this
    enable-parallel-processing: true

    # PRODUCTION: More threads for parallel processing
    # BusinessHikariPool has maximumPoolSize=20, so 8 threads is safe
    parallel-threads: 8

    # PRODUCTION: Keep statistics logging enabled for monitoring
    log-batch-statistics: true
  query:
    max-page-size: 100
    default-page-size: 20
    default-sort-column: transactionDateTime
    default-sort-direction: desc
  columns:
    visibility:
      # ROLE_ADMIN: Full access to all columns
      admin:
        - id
        - transactionDateTime
        - amount
        - balance
        - orderId
        - reference
        - payIn
        - accountNo
        - utr
        - gatewayTransactionId
        - uploadTimestamp
        - approvalStatus
        - processed
        - type
        - uploadId
        - uploadUsername
        - bankName
        - bankParserKey

      # ROLE_USER: Limited access to non-sensitive columns
      user:
        - transactionDateTime
        - amount
        - orderId
        - reference
        - payIn
        - utr
        - uploadTimestamp
        - bankName

# ============================================================================
# LOGGING CONFIGURATION (PRODUCTION)
# ============================================================================
logging:
  level:
    root: INFO
    # Security Database Logs
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.repository.security: DEBUG
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.adapter.security: DEBUG
    # Business Database Logs
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.repository.business: DEBUG
    com.paytrix.cipherbank.infrastructure.adapter.out.persistence.adapter.business: DEBUG
    # Hibernate SQL (shows queries from both databases)
    org.hibernate.SQL: DEBUG
    # Application logs
    com.paytrix.cipherbank: INFO
    # DataSource logs (to see which database is being used)
    com.zaxxer.hikari.HikariConfig: DEBUG
    com.zaxxer.hikari.HikariDataSource: INFO
    # Kafka logs
    org.apache.kafka: INFO
    org.springframework.kafka: INFO
